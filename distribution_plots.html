<!DOCTYPE html>
<html>
    <head>
        <title>Distribution Plots</title>
        
        <!-- Required meta tags -->
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
            
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.css">
        
        <style>
            body {
    
                width: 1300px;
                padding: 20px;
                margin:0 auto;
                font-size:10pt;
                color: #333;
            }
            .title_head {
                background-color: #BEF781;
                padding: 5px;
                text-align: center;
                font-size: 28px;
                font-weight: 10;
            }
            
			div.fixed-row {
				width: 1300px;
			} 
			
            div.half-plot {
                width: 600px;
                height: 500px;
            }
            div.full-plot {
                width: 1300px;
                height: 800px;
            }
            div.square-plot {
                width: 1300px;
                height: 1100px;
            }
        </style>

    <script src="https://cdn.plot.ly/plotly-latest.js"></script>
    <!-- generated by fund_parser.py -->
    <script src="fund_content.js"></script>
    <!-- generated by survey_parser.py -->
    <script src="score_content.js"></script>
    <!-- generated by user_parser.py -->
    <script src="user_content.js"></script>
    <script>
        window.onload = updatePage;
		
		// Plotly mode bar config for big
        var plotlyConfigBig = {
            displayModeBar: true,
            modeBarButtonsToRemove: [
                'sendDataToCloud',
                'zoom2d', 'pan2d',
                'select2d', 'lasso2d',
                'zoomIn2d', 'zoomOut2d',
                'autoScale2d', 'resetScale2d',
                'toggleSpikelines',
				'hoverClosestCartesian',
				'hoverCompareCartesian'
            ]/*,
			modeBarButtonsToAdd: [{
			    name: 'Download PNG Image',
			    icon: Plotly.Icons.camera,
			    click: function(gd) {
				  Plotly.downloadImage(gd, {format: 'png', width:1537, height:850, scale:5})
			    }
			  }]*/
        };
        
		// Plotly mode bar config for half
        var plotlyConfigSquare = {
            displayModeBar: true,
            modeBarButtonsToRemove: [
                'sendDataToCloud',
                'zoom2d', 'pan2d',
                'select2d', 'lasso2d',
                'zoomIn2d', 'zoomOut2d',
                'autoScale2d', 'resetScale2d',
                'toggleSpikelines',
				'hoverClosestCartesian',
				'hoverCompareCartesian'
            ]/*,
			modeBarButtonsToAdd: [{
			    name: 'Download SVG Image',
			    icon: Plotly.Icons.camera,
			    click: function(gd) {
				  Plotly.downloadImage(gd, {format: 'png', width:1159, height:1150, scale:2})
			    }
			  }]*/
        };
		
		// Main caller function to generate the plots
        function updatePage(){            

			var userArray = userInfoString.split("\n");
			
			var usrAffFac = Array.apply(null, Array(userAffListEng.length)).map(x => Array.apply(null, Array(userFacListEng.length)).map(Number.prototype.valueOf, 0));
			// Go through each pi list and compile stat
			for (var p=1; p<userArray.length; p++){
				var pCol = userArray[p].split("\t");
				//Use in platform order
				var pAffInd = userAffListEng.indexOf(pCol[2]);
				if (pAffInd == -1 || isNaN(pAffInd)){console.log("Aff: " + pCol[2] + pAffInd);}
				var pFacInd = userFacListEng.indexOf(pCol[3]);
				if (pFacInd == -1 || isNaN(pFacInd)){console.log("Fac: " + pCol[3] + pFacInd);}
				usrAffFac[pAffInd][pFacInd] += 1;
			};
			
            // Make affliation vs facility plot
            makeAffliationFacilityPlot("plt-affFac-chart", usrAffFac, userAffLabelEng, userFacLabelEng, "Figure 12. Distribution of users 2019");
            
			// Make funding bar
			makeFundBar("fund-bar-chart", fundStat, "Figure 8. Distribution of funding across SciLifeLab facilities in 2019");
            
            // Make score bar
            makeScoreBar("score-bar-chart", scoreObject, "Figure 15. Facility user survey avg satisfaction score");
            
            // Make fund and pub scatter
			makeFundScatter("funding-pub", fundStat, "pub", "Total Funding (log10)", "Publications (log10)", true, "Figure 10. Total funding vs publications 2019");
            
            
		
        };
        
	    /*
		PLOTING FUNCTIONS
		*/
		
        // Function to make affliation vs facility stat plot
        function makeAffliationFacilityPlot(divID, dataArray, afAb, fcAb, fName){
			var mCol = ["#1E3F32", "#01646B", "#4f9b74", "#80C41C", "#1b918d", "378CAF", "#468365", "#AECE53", "#87B0AB", "#AEC69C", "#819e90", "#B1B0B1", "#1E3F32", "#01646B", "#4f9b74", "#80C41C", "#1b918d",];
            var data = [];
            for (var r=0; r < dataArray.length; r++){
                var marker_text = [];
                var marker_size = [];
                var trace = {x:[], y:[], mode:'markers', type:'scatter'};
                for (var c=0; c < dataArray[r].length; c++){
                    if (dataArray[r][c] > 0) {
                        trace['x'].push(c+1);
                        trace['y'].push(r+1);
                        marker_size.push(getMarkerSize(dataArray[r][c]));
                        marker_text.push(dataArray[r][c] + ' ' + afAb[r]);
                    };
                };
                trace['marker'] = {
                    size: marker_size,
                    color: mCol[r]
 /*                   colorscale: "Greens",
                    reversesclae: true,
                    showscale: true */
                };
                trace['text'] = marker_text;
                trace['name'] = afAb[r];
                trace['hoverinfo'] = "x+text";
                data.push(trace);
            };
            
            var layout = {
                /*title: {
					text: gTitle,
					font: {family: "Arial", size: 26}
				},*/
                showlegend: false,
                xaxis: {
					title: {
						text: "Facilities",
						font: { family: "Arial", size: 18 }
					},
                    tickvals: Array.from({length: fcAb.length}, (x,i) => i+1),
                    ticktext: fcAb,
                    tickfont: { family: "Arial", size: 16 },
                    tickangle: -40,
                    zerolinecolor: "#6E6E6E",
					domain: [0.12, 1]
                },
                yaxis: {
					title: { 
						text: "Affiliation",
						font: { family: "Arial", size: 18 }
					},
                    tickvals: Array.from({length: afAb.length}, (x,i) => i+1),
                    ticktext: afAb,
                    tickfont: { family: "Arial", size: 16 },
					tickangle: -40,
                    zerolinecolor: "#6E6E6E",
					domain: [0.20, 1.5]
                }
            };
            
            Plotly.newPlot(divID, data, layout, Object.assign({toImageButtonOptions: { format: 'png', filename: fName, width:1537, height:850, scale: 3}}, plotlyConfigBig));
        };
		
		function getMarkerSize(point){
			if (point == 0){
				return 0;
			} else {
				return (Math.sqrt(point) * 4) + 5;
			} 
		};
        
		// Make fund bar plot
		function makeFundBar(divID, fList, fName="new_plot"){
			var fNam = fList.map(x => x.fname);
			var data = [
				{
					type: 'bar',
					x: fNam,
					y: fList.map(x => x.ofund),
					name: "Other funding",
					hoverinfo: 'none',
					marker: {color: "#378CAF"}
				},
				{
					type: 'bar',
					x: fNam,
					y: fList.map(x => x.ufund),
					name: "University funding",
					hoverinfo: 'none',
					marker: {color: "#A48FA9"}
				},
				{
					type: 'bar',
					x: fNam,
					y: fList.map(x => x.sfund),
					name: "SciLifeLab funding",
					hoverinfo: 'none',
					marker: {color: "#80C41C"}
					
				}
			];
			
			var layout = {
				/*title: {
					text: "Facility Funding",
					font: {family: "Arial", size: 26}
				},*/
				barmode: 'stack',
                xaxis: {
                    tickvals: Array.from({length: fNam.length}, (x,i) => i),
                    ticktext: fNam,
                    tickfont: { family: "Arial", size: 17 },
					tickangle: -40,
                    zerolinecolor: "#6E6E6E",
					domain: [0.09, 1]
                },
				yaxis: {
					title: {
						text: "SEK",
						font: {family: "Arial", size: 22}
					},
					domain: [0.35, 1]
				},
				legend: {
					font: {family: "Arial", size: 21},
					x: 0.85,
					bordercolor: "#5a5c60",
					borderwidth: 0.4
				}
			};
			
            Plotly.newPlot(divID, data, layout, Object.assign({toImageButtonOptions: { format: 'png', filename: fName, width:1537, height:850, scale: 3}}, plotlyConfigBig));
		}
        
		// Make fund bar plot
		function makeScoreBar(divID, sObj, fName){
			var fNam = sObj.fnames;
			var data = [
				{
					type: 'bar',
					x: fNam,
					y: sObj.qscore,
					name: "Quality",
					hoverinfo: 'none',
					marker: {color: "#80C41C"}
				},
				{
					type: 'bar',
					x: fNam,
					y: sObj.sscore,
					name: "Service",
					hoverinfo: 'none',
					marker: {color: "#A48FA9"},
                    yaxis: 'y2'
				},
				{
					type: 'bar',
					x: fNam,
					y: sObj.iscore,
					name: "Importance",
					hoverinfo: 'none',
					marker: {color: "#378CAF"},
					yaxis: 'y3'
				}
			];
			
			var layout = {
				/*title: {
					text: "Facility Funding",
					font: {family: "Arial", size: 26}
				},
				barmode: 'stack',*/
                xaxis: {
                    tickvals: Array.from({length: fNam.length}, (x,i) => i),
                    ticktext: fNam,
                    tickfont: { family: "Arial", size: 16 },
					tickangle: -40,
                    zerolinecolor: "#6E6E6E",
					domain: [0.065, 1]
                },
                grid: {
                    rows: 3,
                    columns: 1,
                    subplots:[['xy'], ['xy2'], ['xy3']],
                    roworder: "bottom to top"
                },
				yaxis: {
					/*title: {
						text: "Quality",
						font: {family: "Arial", size: 19}
					},*/
                    domain: [0.28, 0.50],
                    range: [1,5],
                    nticks: 5
				},
				yaxis2: {
					domain: [0.53, 0.75],
                    range: [1,5],
                    nticks: 5
				},
				yaxis3: {
					domain: [0.78, 1],
                    range: [1,5],
                    nticks: 5
				},
				legend: {
                    traceorder: "reversed",
					font: {family: "Arial", size: 17},
					x: 0.395,
                    y: 1.1,
					bordercolor: "#5a5c60",
					borderwidth: 0.4,
                    orientation: 'h'
				}
			};
			
            Plotly.newPlot(divID, data, layout, Object.assign({toImageButtonOptions: { format: 'png', filename: fName, width:1537, height:850, scale: 3}}, plotlyConfigBig));
		}

		function makeFundScatter(divID, fLis, oNam, xNam, yNam, noZero, fName){
            var fList = [...fLis];
            fList.splice(22, 1);
            console.log(fList);
			var tFund = fList.map(x => Math.log10(x.tfund));
			var allPlt = ['Genomics', 'Drug Discovery and Development',
						  'Diagnostics Development', 'Proteomics and Metabolomics', 'Bioinformatics',
						  'Cellular and Molecular Imaging', 'Chemical Biology and Genome Engineering'];
			//var pltCol = ["#1E3F32", "#01646B", "#4D4D4D", "#AECE53", "#80C41C", "#378CAF", "#468365", "#AEC69C"];
			//var pltCol = ["#1E3F32", "#ad6ee5", "#3d4799", "#dbb134", "#80C41C", "#378CAF", "#ebed74", "#ea6a3f"];
			var pltCol = ["#1E3F32", "#ad6ee5", "#dbb134", "#80C41C", "#378CAF", "#ebed74", "#ea6a3f"];
			var data = [];
			for (var p=0; p<allPlt.length; p++){
				var pData = getPlatformObj(fList, allPlt[p], oNam, noZero);
				//console.log(pData);
				var trace = {x: pData.x,
							 y: pData.y,
							 name: allPlt[p],
							 text: pData.fnm,
							 textfont: {family: "Arial", size: 8},
							 textposition: 'top center',
							 type: 'scatter',
							 mode: 'markers',
							 marker: {color: pltCol[p], size: 35, opacity:0.85}
							 };
				data.push(trace);
			}

			
			var layout = {
				/*title: {
					text: "Total funding VS FTE",
					font: {family: "Arial", size: 26}
				},*/
				xaxis: {
					title: {
						text: xNam,
						font: {family: "Arial", size: 27}
					},
					tickfont: { family: "Arial", size: 25 },
					domain: [0.02, 1]
				},
				yaxis: {
					title: {
						text: yNam,
						font: {family: "Arial", size: 27}
					},
					zeroline: false,
					domain: [0.03, 0.97],
					tickfont: { family: "Arial", size: 25 }
				},
				legend: {
					y: 1.08,
					xanchor: "center",
					orientation: "h",
					font: {family: "Arial", size: 23}
				}
			};
			
            Plotly.newPlot(divID, data, layout, Object.assign({toImageButtonOptions: { format: 'png', filename: fName, width:1159, height:1150, scale: 3}}, plotlyConfigSquare));
		}
        
		/*
		HELPER FUNCTIONS
		*/
		
		// Get objects by platform
		function getPlatformObj(oList, plt, oKey, nZer){
			var oData = {x:[], y:[], fnm:[]};
			for (var l=0; l<oList.length; l++){
				if (oList[l].plat == plt){
					if(oList[l][oKey] > 0){
						oData.x.push(Math.log10(oList[l].tfund));
						oData.y.push(Math.log10(oList[l][oKey]));
						oData.fnm.push(oList[l].fname);
					} else if (nZer == false){
						oData.x.push(Math.log10(oList[l].tfund));
						oData.y.push(0);
						oData.fnm.push(oList[l].fname);
					}
				}
			}
			return oData;
		}
		
    </script>
    </head>
    
    <body>
        <div>
            <p class="title_head">Facility and Affiliation distribution 2019</p>
		    <div id="plt-affFac-chart" class="full-plot"></div>
        </div>
        <div>
            <p class="title_head">Distribution of funding SciLifeLab facilities 2019</p>
		    <div id="fund-bar-chart" class="full-plot"></div>
        </div>
        <div>
            <p class="title_head">Satisfaction score of facilities 2018</p>
		    <div id="score-bar-chart" class="full-plot"></div>
        </div>
        <div>
            <p class="title_head">Total funding vs publications for SciLifeLab facilities 2019</p>
		    <div id="funding-pub" class="full-plot"></div>
        </div>


        <script src="https://code.jquery.com/jquery-3.3.1.slim.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.js"></script>
               
    </body>
</html>